---
timezone: Asia/Shanghai
---

> 请在上边的 timezone 添加你的当地时区，这会有助于你的打卡状态的自动化更新，如果没有添加，默认为北京时间 UTC+8 时区
> 时区请参考以下列表，请移除 # 以后的内容

timezone: Pacific/Honolulu # 夏威夷-阿留申标准时间 (UTC-10)

timezone: America/Anchorage # 阿拉斯加标准时间 (UTC-9)

timezone: America/Los_Angeles # 太平洋标准时间 (UTC-8)

timezone: America/Denver # 山地标准时间 (UTC-7)

timezone: America/Chicago # 中部标准时间 (UTC-6)

timezone: America/New_York # 东部标准时间 (UTC-5)

timezone: America/Halifax # 大西洋标准时间 (UTC-4)

timezone: America/St_Johns # 纽芬兰标准时间 (UTC-3:30)

timezone: America/Sao_Paulo # 巴西利亚时间 (UTC-3)

timezone: Atlantic/Azores # 亚速尔群岛时间 (UTC-1)

timezone: Europe/London # 格林威治标准时间 (UTC+0)

timezone: Europe/Berlin # 中欧标准时间 (UTC+1)

timezone: Europe/Helsinki # 东欧标准时间 (UTC+2)

timezone: Europe/Moscow # 莫斯科标准时间 (UTC+3)

timezone: Asia/Dubai # 海湾标准时间 (UTC+4)

timezone: Asia/Kolkata # 印度标准时间 (UTC+5:30)

timezone: Asia/Dhaka # 孟加拉国标准时间 (UTC+6)

timezone: Asia/Bangkok # 中南半岛时间 (UTC+7)

timezone: Asia/Shanghai # 中国标准时间 (UTC+8)

timezone: Asia/Tokyo # 日本标准时间 (UTC+9)

timezone: Australia/Sydney # 澳大利亚东部标准时间 (UTC+10)

timezone: Pacific/Auckland # 新西兰标准时间 (UTC+12)

---

# {Naomi}

1. 自我介绍
2. 你认为你会完成本次残酷学习吗？必须的

## Notes

<!-- Content_START -->

### 2024.09.19
# Chapter3运输层

运输层位于应用层和网络层之间，是分层的网络体系结构的重要部分。主要关注TCP和UDP运输层协议

# 3.1 运输层服务

发送端的应用程序-》发送端运输层-〉发送端网络层-》接受端网络层-》接受端运输层

- **发送端应用程序 → 发送端运输层**：
    - 发送端的应用程序将数据发送给运输层。运输层会将应用程序的数据分割成较小的块（报文段，segment），并为每个报文段加上运输层首部。运输层的首部包含端口号、序列号、校验和等信息，以便在接收端进行数据的重组和校验。
- **发送端运输层 → 发送端网络层**：
    - 运输层将封装好的报文段交给网络层。网络层会将报文段封装进网络层的数据报（数据包），并加上网络层首部，通常包括源 IP 地址、目的 IP 地址等信息。
- **发送端网络层 → 接收端网络层**：
    - 网络层将封装好的数据报通过路由器传递到网络中的下一个节点，经过多个路由器转发，最终到达目的地网络层。路由器只处理数据报的网络层信息（例如 IP 地址），而不关心封装在数据报中的运输层报文段。

运输层的类比：2个家庭间的通信，Ann和Bill负责各自家庭内部的收发邮件

Ann和Bill都是在各自家里进行工作的;例如，他们并没有参与任何一个中间邮件中心对邮件进行分拣，或者将邮件从一个邮件中心送到另一个邮件中心之类的工作。类似地，运输层协议只工作在端系统中。在端系统中，运输层协议将来自应用进程的报文移动到网络边缘(即网络层)但对有关这些报文在网络核心如何移动并不作任何规定。事实上，如图3-1所示，中间路由器既不处理也不识别运输层加在应用层报文的任何信息

UDP(用户数据报协议)，它为调用它的应用程序提供了一种不可靠、无连接的服务。另一种是TCP(传输控制协议)，它为调用它的应用程序提供了一种可靠的、面向连接的服务

每台主机有一个IP地址。因特网网络层协议有一个名字叫IP，即网际协议。IP为主机之间提供了逻辑通信。

UDP 和 TCP 的主要职责之一就是在 IP 提供的**主机到主机**传递服务的基础上，进一步扩展为**进程到进程**的传递服务。主机间的信息传递因为有UDP和TCP的存在，扩展成了端系统上的两个进程之间的信息传递

### 2024.09.20

### 2024.09.21

# 3.2多路复用与多路分解

在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息(这将在以后用于分解)从而生成报文段，然后将报文段传递到网络层，所有这些工作称为多路复用(multiplexing)

一个进程(作为网络应用的一部分)有一个或多个套接字(socket)，在接收主机中的运输层际上并没有直接将数据交付给进程，而是将数据交给了一个中间的套接字，套接字有唯一的端口号，在报文中有目的端口号，当报文段到达主机时，运输层检查报文段中的目的端口号，并将其定向到相应的套接字，这个过程称为多路分解(demultiplexing)。

多路复用发生在发送端，多路分解发生在接收端

服务器在12000端口等待连接，客户端发送请求连接，服务器收到请求连接到报文后，根据报文中的:①该报文段中的源端口号;②源主机IP地址;③该报文段中的目的端口号;④自身的IP地址。创建套接字， 如果后续到达的报文的4个值和该请求报文的一样，则会被分配到这个套接字

连接套接字与进程之间并非总是有着一一对应的关系。事实上，当今的高性能Web服务器通常只使用一个进程，但是为每个新的客户连接创建一个具有新连接套接字的新线程。

# 3.3UDP

运输层最低限度必须提供一种复用/分解服务.UDP只是做了运输协议能够做的最少工作

将报文段中的数据交付给正确的应用进程。值得注意的是，使用UDP时，在发送报文段之前，发送方和接收方的运输层实体之间没有握手。正因为如此，UDP被称为是无连接的

DNS是使用UDP的应用层协议  HTTP使用TCP

因为有许多应用更适合用UDP，原因主要以下几点:

- 比较快 UDP就会将此数据打包进UDP报文段并立即将其传递给网络层
- 无连接状态

UDP应用：

因特网电话、实时视频会议、流式存储音频与视频

TCP应用：

电子邮件、远程终端访问、Web及文件传输

### 差错检测

检测当UDP报文段从源到达目的地移动时，其中的比特是否发生了改变

因为无法确保每条链路都使用有差错检测的协议，也无法确保内存中的差错检测（指的是数据从一个应用程序到另一个应用程序的过程出现错误或者是应用程序内部错误），所以UDP就必须在端到端基础上在运输层提供差错检测。

# 3.4可靠数据传输原理

## 3.4.1构造可靠数据传输协议

1. 假设底层信道是完全可靠的。
2. 假设分组中的比特可能受损，但是所有发送的分组(虽然有些比特可能受损)将按其发送的顺序被接收
    
    如果报文接收者听到一句含糊不清的话时，他可能要求你重复那句容易误解的话。这种口述报文协议使用了肯定确认(positive ac-knowledgment)(“OK”) ACK（ac-knowledgment)与否定确认(negative acknowledgment)(“请重复一遍”)NCK。基于这样重传机制的可靠数据传输协议称为自动重传请求协议。
    
    发送方收到上层信息，发送分组-等待接受方的ACK或NAK分组-若为NAK或是上一个分组的ACK，就重新传输；若为ACK就等待上层数据（发送方将不会发送一块新数据，除非发送方确信接收方已正确接收当前分组。）这样的协议称为停等(stop-and-wait)协议。
    
3. 考虑到ACK或NAK分组受损的可能性
    
    当发送方收到含糊不清的ACK或NAK分组时，只需重传当前分组-》冗余分组（接收方不知道这个分组是新的还是重传）-〉发送方对分组编号，如果编号一样就是重传
    
    比特交替协议（rdt3.0)：分组序号在0和1之间交替
    
    ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/9eb2bdc2-f3ad-4599-b55e-a13acab844ff/image.png)
    

### 3.4.2流水线可靠数据传输协议

rdt3.0因为是一个停等协议，所以有效吞吐量很低，即使底层网络硬件的传输速率很好，也被协议限制了传输速度

有效吞吐量=成功传输的数据量/总传输时间

解决方法：允许发送方发送多个分组而无须等待确认。因为许多从发送方向接收方输送的分组可以被看成是填充到一条流水线中，所以这种技术被称为流水线。要实现流水线，就必须：
1. 增加序号范围 因为每个输送中的分组必须有一个唯一的序号

1. 发送方和接收方要缓存多个分组

解决流水线的差错恢复有两种基本方法是:回退N步(Go-Back-N，GBN)和选择重传(Selective Repeat，SR)。

### **3.4.3 回退N步**
 
**GBN 协议的工作机制**

- **发送方**：可以一次发送多个分组，但发送窗口内的分组数量不能超过 `N`（窗口大小）。当发送方发送分组时，它不会等待每个分组的单独确认，而是通过滑动窗口机制管理这些分组。 假设窗口长度是4，那么发送方发送了0-3个分组后，必须等待分组确认（当收到一个ACK0的时候，窗口就向前移动，发送方就可以发送新的分组）
- **接收方**：
    - 期望按序接收分组。
    - 只会将按序到达的分组交付给上层，即分组的序列号必须是接收方期望的下一个序列号（按序号递增）。
    - 如果接收到的分组序号正好是期望的分组（如当前期望的是分组 `n`，而接收到了序列号为 `n` 的分组），则接收方会将该分组交付给上层，并发送一个累积确认（ACK n），表明所有序列号小于等于 `n` 的分组都已经成功接收。如果接收方收到的分组不是当前期望的序列号（即乱序到达），则会丢弃该分组并重发上次按序收到的分组的确认。

### **3.4.4 选择重传**
### 2024.09.22
TO be continued
### 2024.09.23
选择重传(SR)协议通过让发送方仅重传那些它怀疑在接收方出错(即丢失或受损)的分组而避免了不必要的重传。接收方可以为每个独立接收到的数据报文段发送确认，即使它们不是按序到达。

SR接收方将确认一个正确接收的分组而不管其是否按序。失序的分组将被**缓存**直到所有丢失分组(即序号更小的分组)皆被收到为止，这时才可以将一批分组按序交付给上层

选择重传和累积确认的例子：
https://lxblog.com/qianwen/share?shareId=326303ba-d3ef-4fd5-935f-a75670653cce

- **序号管理**：
    - 为了防止分组的序号被重新使用，发送方必须确保在一定时间内不再使用某个序号。这个时间通常与网络中的分组最大存活时间（Maximum Segment Lifetime, MSL）有关。
- **最大存活时间**：
    - MSL是指一个分组在网络中存活的最长时间。通过设定这个时间，发送方可以“确信”在这个时间内发送的所有分组都已经被接收方处理，或者已不再在网络中。因此，发送方在此时间段内不会重新使用这些序号。

## 3.5面向连接的运输:TCP

### 3.5.1TCP连接

TCP 被称为是面向连接的(connection-oriented)，这是因为在一个应用进程可以开始向另一个应用进程发送数据之前，这两个进程必须先相互“握手”，即它们必须相互发送某些预备报文段，以建立确保数据传输的参数

TCP连接也总是点对点(point-to-point)的，即在单个发送方与单个接收方之间的连接

全双工：主机A在向主机B发送数据的同时，也许也接收来自主机B的数据

### 三次握手的概述

客户首先发送一个特殊的TCP报文段，服务器用另一个特殊的TCP报文段来响应，最后，客户再用第三个特殊报文段作为响应。前两个报文段不承载“有效载荷”，也就是不包含应用层数据;而第三个报文段可以承载有效载荷。由于在这两台主机之间发送了3个报文段，所以这种连接建立过程常被称为三次握手

客户进程发送数据-》数据经过套接字-》数据开始有TCP控制-》TCP将数据放到发送缓存中-》TCP不时地将数据从缓存中取出并传递到网络层-》网络层将数据封装到IP数据报并发送到网络

在接收端的TCP收到报文-》存入接收缓存-》应用程序从缓存中读取数据

### 3.5.2TCP报文段结构

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/0f8ed61e-97eb-43e4-9c52-db8566093739/image.png)

TCP报文段首部中两个最重要的字段是序号字段和确认号字段。这两个字段是TCP可靠传输服务的关键部分

序号字段是建立在传送的字节流之上：eg：假设主机A上的一个进程想通过一条TCP连接向主机B上的一个进程发送一个数据流。主机A中的TCP将隐式地对数据流中的每一个字节编号。假定数据流由一个包含500000字节的文件组成，其MSS为1000字节，数据流的首字节编号是0。如图3-30所示，该TCP将为该数据流构建500个报文段。给第一个报文段分配序号0，第二个报文段分配序号1000，第三个报文段分配序号2000，以此类推

确认号字段

主机A填充进报文段的确认号是主机A期望从主机B收到的下一字节的序号

重置报文段：RST

假如一台主机接收了具有目的端口80的一个TCPSYN分组，但该主机在端口80不接受连接(即它不在端口80上运行Web服务器)。则该主机将向源发送一个特殊重置报文段。该TCP报文段将RST标志位置为1

**TCP的例子**：telnet应用

假设客户和服务器的起始序号分别是42和79

第一个报文段是由客户发往服务器，在它的数据字段里包含一字节的字符'C'的ASCII码。第一个报文段的序号字段里是42

 第二个报文段是由服务器发往客户。它有两个目的:首先它是为该服务器所收到数据提供一个确认。通过在确认号字段中填入43，服务器告诉客户它已经成功地收到字节42及以前的所有字节，现在正等待着字节43的出现。该报文段的第二个目的是回显字符C’

第三个报文段是从客户发往服务器的。它的唯一目的是确认已从服务器收到的数据，该报文段的数据字段为空

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/5a436849-ae25-4939-afcf-6ce4e72317c0/image.png)

### 3.5.3往返时间的估计与超时

**往返时间的估计**

在任意时刻，仅为一个已发送的但目前尚未被确认的报文段估计Samp-leRTT，从而产生一个接近每个RTT的新SampleRTT值,而不是为每个发送到报文测量SampleRTT值。

由于路由器的拥塞和端系统负载的变化，这些报文段的SampleRTT值会随之波动。为了估计一个典型的RTT，自然要采取某种对SampleRTT取平均的办法：加权平均，对最近的样本赋予的权值要大于对旧样本赋予的权值。因为越近的样本越能更好地反映网络的当前拥塞情况。

**超时**

超时间隔必须大于该连接的往返时间(RTT)，即从一个报文段发出到它被确认的时间

### TCP是如何提供可靠数据传输的

假定数据仅向一个方向发送，即从主机A到主机B，且主机A在发送一个大文件

TCP发送方有3个与发送和重传有关的主要事件:从上层应用程序接收数据;定时器超时和收到ACK。

定时器超时:当报文段被传给IP时，TCP就启动定时器

收到ACK: TCP将ACK的值y与它的变量SendBase进行比较。TCP状态变量SendBase是最早未被确认的字节的序号。如果y>SendBase，则该ACK是在确认一个或多个先前未被确认的报文段。因此发送方更新它的SendBase变量;如果当前有未被确认的报文段，TCP还要重新启动定时器。重新启动定时器是为了那些已经被发送但是还没有被确认的数据

TCP重传的2种情况：

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/3a63a7e8-4bf3-446f-a7e3-88a31ab0fda1/image.png)

情况1：

当主机B收到该重传的报文段时，它将通过序号发现该报文段包含了早已收到的数据。因此，主机B中的TCP将丢弃该重传的报文段中的这些字节

情况2：
假设在超时之前这两个报文段中没有一个确认报文到达主机A。当超时事件发生时，主机A重传序号92的第一个报文段，并重启定时器。

只要第二个报文段的ACK在新的超时发生以前到达，则第二个报文段将不会被重传

**快速重传**

长超时周期增加了端到端时延，所以发送方通过在超时之前注意冗余ACK来检测丢包

当TCP接收方收到一个序号大于下一个所期望的、按序的报文段时，它会继续发送最后一个正确接收到的字节的ACK。因为TCP不使用否定确认，所以使用这种重复确认的方法。

发送方一旦收到对相同数据的3个冗余ACK，就知道这个已被确认过3次的报文段之后的报文段已经丢失。

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/caf1375a-3aab-4043-beb4-4c79284fd4ce/image.png)

TCP的差错恢复机制是GBN和SR协议的混合体

GBN: TCP默认使用累积确认，发送方只需维持已发送过但未被确认的字节的最小序号和下一个要发送到字节的序号

SR: TCP支持选择确认（对于丢失的报文段n，只会重传报文段n）；缓存失序的报文段

**流量控制服务**(flow-control service)以消除发送方使接收方缓存溢出

TCP通过让发送方维护一个称为**接收窗口**(receive window)的变量来提供流量控制。通俗地说，接收窗口用于给发送方一个指示一-该接收方还有多少可用的缓存空间

假设主机A通过一条TCP连接向主机B发送一个大文件。主机B为该连接分配了一个接收缓存，并用RcvBuffer来表示其大小

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/01913280-45e1-4116-ab0a-c82bf2564d37/image.png)

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/fc48b6b4-9991-40ab-97cb-afba653deee0/image.png)

当主机B的接收窗口为0时，主机B会通告给主机A，主机A会停止发送数据，然后发送只有一个字节数据的探测报文段。这些报文段将会被接收方确认，然后主机B清空缓存-》发送将包含一个非0的rwnd 值的确认报文 

### 3.5.6TCP 连接管理

### 一条TCP连接是如何建立的(三次握手)

应用进程首先通知客户TCP→客户中的TCP会用以下方式与服务器中的TCP建立一条TCP连接:

1. 客户端的TCP首先向服务器端的TCP发送一个特殊的TCP报文段。在报文段的首部(参见报文结构图)中的一个标志位(即SYN比特)被置为1。因此这个特殊报文段被称为SYN报文段。客户会随机选择一个初始序号(client_isn)也就是**（Sequence Number）。**然后该报文被封装在一个IP数据报中，并发给服务器
2. 服务器会从该IP数据报中提取出TCPSYN报文段，为该TCP连接分配TCP缓存和变量，并向该客户TCP发送允许连接的报文段。
    
    这个报文首部中：SYN比特被置为1；确认号字段被置为client_isn + 1；服务器选择自己的初始序号( server_isn)，并将其放置到TCP报文段首部的序号字段中
    
    该允许连接的报文段被称为SYNACK报文段
    
3. 在收到SYNACK报文段后，客户也要给该连接分配缓存和变量。该客户通过将值server_isn+1放置到TCP报文段首部的确认字段中来对服务器的允许连接的报文段进行确认。因为连接已经建立了，所以SYN比特被置为0

### TCP连接的终止

客户端应用进程发送关闭连接的命令→

1. 客户端TCP向服务器进程发送一个特殊的TCP报文。在报文段的首部(参见报文结构图)中的一个标志位(即FIN比特)被置为1。
2. 服务器发送ACK确认报文→服务器发送FIN终止报文
3. 客户端发送ACK对服务器的终止报文做确认

这样 在2台主机上的用于该链接的资源都被释放了

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/79540fec-2945-478a-8267-f98c469cece2/image.png)

### 客户TCP经历的典型的TCP状态序列

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/7d2661e4-adfb-4a5a-8e85-3799d91c9041/image.png)

当客户TCP收到服务器的FIN报文段后，客户TCP对服务器的报文段进行确认，并进入TIME_WAIT状态。假定ACK 丢失，TIME_WAIT 状态使TCP客户重传最后的确认报文。在TIME_WAIT状态中所消耗的时间是与具体实现有关的，而典型的值是30秒、1分钟或2分钟。经过等待后，连接就正式关闭

### SYN洪泛攻击

在TCP连接中，如果某客户不发送ACK来完成该三次握手的第三步，最终(通常在一分多钟之后)服务器将终止该半开连接并回收资源。

SYN洪泛攻击：攻击者发送大量的TCP SYN报文段，而不完成第三次握手的步骤。随着这种SYN报文段纷至沓来，服务器不断为这些半开连接分配资源(但从未使用)，导致服务器的连接资源被消耗殆尽。

防御方法：SYNcookie

1. 当服务器接收到一个SYN报文段时,服务器生成一个初始TCP序列号,该序列号是SYN报文段的源和目的IP地址与端口号以及仅有该服务器知道的秘密数的一个复杂函数(散列函数)。这种精心制作的初始序列号被称为“cookie”。服务器并不记忆该cookie 或任何对应于 SYN 的其他状态信息
    
    在前面讲的TCP连接中，对于一个合法的ACK，客户端在确认字段中的值等于在SYNACK 字段(此时为cookie值)中的值加1
    
2. 如果该函数的结果加1与在客户的SYNACK中的确认(cookie)值相同的话，服务器认为该ACK对应于较早的SYN报文段，因此它是合法的。服务器则生成一个具有套接字的全开的连接。·在另一方面，如果客户没有返回一个ACK报文段，则初始的SYN并没有对服务器产生危害，因为服务器没有为它分配任何资源。

### 服务器端TCP经历的典型的TCP状态序列

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/26f66e2c-1ce6-4b8d-92ac-30862dcd9f43/image.png)

### 3.6拥塞控制原理

随着主机增加其发送速率并使网络变得拥塞，这时会发生的情况：
**情况1:两个发送方和一台具有无穷大缓存的路由器**

假设2台主机都有1条连接，且这2条连接共享源和目的地之间的单条路由

发送速率超过R/2时，它的吞吐量（接收方每秒接收的字节数，也就是网络在单位时间内成功传输的数据量）只能达R/2。这个吞吐量上限是由两条连接之间共享链路容量造成的。

虽然从吞吐量角度看，运行在总吞吐量接近R的状态也许是一个理想状态，但从时延角度看，却远不是一个理想状态。

- **吞吐量（Throughput）**：网络在单位时间内成功传输的数据量，通常以比特每秒（bps）表示。
- **供给载荷（Offered Load）**：用户或应用程序向网络传输的总数据量。

## 供给载荷与吞吐量的关系

- 当网络中供给载荷较小时，吞吐量大致等于供给载荷，即供给的流量都能被成功传输。
- 当供给载荷超过网络的承载能力（即瓶颈带宽）时，网络会发生拥塞，导致数据包丢失、重传等现象，实际吞吐量将无法继续增加，甚至会下降。

**情况2:两个发送方和一台具有有限缓存的路由器**

假设当分组到达一个已满的缓存时会被丢弃，然后会被发送方重传

在情况2下实现的性能强烈地依赖于重传的方式

**情况3:发送方也许会提前发生超时并重传在队列中已被推迟但还未丢失的分组**

拥塞的代价：

- 发送方必须执行重传以补偿因为缓存溢出而丢弃(丢失)的分组
- 发送方在遇到大时延时所进行的不必要重传会引起路由器利用其链路带宽来转发不必要的分组副本

### 2024.09.24
### 3.6.2拥塞控制方法

根据网络层是否为运输层拥塞控制提供了显式帮助分了两种主要拥塞控制方法：

1. 端到端拥塞控制 网络层没有为运输层拥塞控制提供显式支持。TCP采用端到端的方法解决拥塞控制
    
    TCP报文段的丢失(通过超时或3次冗余确认而得知)被认为是网络拥塞的一个迹象，TCP会相应地减小其窗口长度
    
    TCP 的窗口大小决定了发送方在等待确认之前可以发送的未确认分组的数量
    
    - **减少发送速率**：窗口长度减小后，发送方在未收到确认之前，能发送的分组数量减少，从而降低了发送速率。
    - **减小网络负载**：通过减小窗口大小，TCP 减少了在网络中同时存在的未确认分组数量，这有助于缓解网络拥塞。
2. 网络辅助的拥塞控制  路由器向发送方提供关于网络中拥塞状态的显式反馈信息

## 3.7 TCP 拥塞控制

 TCP所采用的方法是让每一个发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率

### 一个TCP发送方如何限制它向其连接发送流量的速率呢?

TCP连接的每一端都是由一个接收缓存、一个发送缓存和几个变量

运行在发送方的TCP拥塞控制机制跟踪一个额外的变量，即拥塞窗口

在一个发送方中未被确认的数据量不会超过cwnd与rwnd中的最小值：

**拥塞控制 vs. 流量控制**

- **拥塞窗口（cwnd）**：用于控制网络中的拥塞情况，表示发送方能够发送的最大未确认数据量。如果网络出现拥塞，cwnd 会减少，限制发送方的发送速率。
- **接收窗口（rwnd）**：用于控制接收方的接收能力，表示接收方缓冲区中可以接收的最大未确认数据量。如果接收方的缓冲区已满，它会通过调整 rwnd 来限制发送方的发送。

为了避免网络拥塞和确保接收方能够处理数据，发送方只能发送未被确认的数据量在cwnd和rwnd、中的最小值之内。这是为了确保：

- **不会导致网络拥塞**：如果发送方的发送量超过了网络能够承受的范围（即 cwnd），可能导致数据包丢失，从而降低整体吞吐量。
- **不会超过接收方的接收能力**：如果发送方的发送量超过接收方的处理能力（即 rwnd），可能会导致接收方的缓冲区溢出，从而导致数据丢失。

### TCP发送方怎样确定它应当发送的速率呢?

- 一个超时事件或3个冗余ACK出现 TCP就会判定为丢包，就会减小拥塞窗口（cwnd）来放慢发送速率
- 当先前未确认的报文段的确认到达的时候，就增加拥塞窗口（cwnd）长度来增加发送速率
- 带宽探测  TCP发送方持续增加传输速率，直到出现丢包才放慢发送速率

### TCP拥塞控制算法

**慢启动**

TCP发送速率起始慢 但是在慢启动阶段以指数增长

何时结束增长？

- 当检测到丢包时，TCP 会将 cwnd 设置为 1，并将 ssthresh 设置为 cwnd 的一半。这一策略的目的是在网络拥塞时，快速降低发送速率，防止进一步的数据丢失。
- 当 cwnd 达到 ssthresh 时，TCP 会结束慢启动，转入拥塞避免模式。

**拥塞避免**

在拥塞避免模式下，cwnd 增长速度减慢，以线性方式增加，通常为每个 RTT 增加 1。

拥塞避免何时结束线性增长？

- 当检测到丢包时，TCP 会将 cwnd 设置为 1，并将 ssthresh慢启动阈值 设置为 cwnd 的一半(也就是进入到快速恢复阶段）

**快速恢复**

检测到丢包-》进入快速恢复阶段-》将拥塞窗口设置为当前的慢启动阈值（通常是拥塞窗口长度的一半）-》重传丢失的分组-》丢失数据成功到达接收方后-》进入拥塞避免阶段

**TCP分岔**

为了让远离数据中心的端系统能快速收到响应 使用TCP分岔

TCP分岔是 客户想临近的前端建立TCP连接，再由这个前端和数据中心交互 这样响应时间大约变为RTT(BE）+处理时间，为什么RTT(BE）会约等于RTT

CDN服务器可以执行TCP分岔

TCP的拥塞控制是：每个往返内cwdn线性增加1MSS,然后出现3个冗余ACK事件的时候cwnd减半（乘性减） Additive-Increase,Multiplicative-Decrease加性增 乘性减

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/877cb2ac-1986-4a4c-84af-e0bf3069e17c/image.png)

TCP吞吐量的宏观描述

TCP的传输速率是拥塞窗口的长度和当前RTT的比值。

当窗口长度是w字节，且当前往返时间是RTT秒时，则TCP的发送速率大约是w/RTT。于是，TCP通过每经过1个RTT将w增加1个MSS探测出额外的带宽，直到一个丢包事件发生为止。当一个丢包事件发生时，用W表示w的值。假设在连接持续期间RTT和W几乎不变，那么TCP的传输速率在W/(2xRTT)到W/RTT之间变化。因为丢包发生的时候，会进入快速恢复阶段，所以窗口长度会减半，所以传输速率是W/(2xRTT)

所以一条TCP连接的平均吞吐量=0.75*W/RTT

<img width="3629" alt="Chapter3运输层" src="https://github.com/user-attachments/assets/9e083fca-fe95-43ab-b00a-225baf155be7">
### 2024.09.24
rest
### 2024.09.25
rest
### 2024.09.26
网络层能够被分解为两个相互作用的部分，即数据平面和控制平面。

数据平面：即网络层中每台路由器的功能 到达路由器输入链路之一的数据报(即网络层的分组)如何转发到该路由器的输出链路之一

控制平面：网络范围的逻辑 选择源主机到目的主机的路径中路由器之间的路由方式（在网络中负责确保数据报（或数据包）能够在路由器之间正确地路由到目的地。）

路由器不运行应用层和运输层协议。

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/357ef064-fbac-4fbc-9027-ac58890f27dd/image.png)

## 转发

转发(forwarding)是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作

## 路由选择

路由选择(routing)是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程。

当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为路由选择算法

### 控制平面：传统的方法

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/4428b64c-58b9-43ba-8308-3c2fcdecc8bd/image.png)

一台路由器中的路由选择算法与其他路由器中的路由选择算法通信，以计算出转发表的值

### 控制平面:SDN方法(Soft-ware-Defined Networking,SDN)

远程控制器确定并分发转发表中的值

计算转发表并与路由器交互的控制器是用软件实现的，故网络是“软件定义”的

网络层提供的服务可能包括：

- 确保交付
- 在具有时延上限的时间内交付
- 有序分组交付
- 确保最小带宽 发送方不能一下子发送太多数据
- 安全性 加密数据报

因特网提供了尽力而为服务

传送的分组既不能保证以它们发送的顺序被接收，也不能保证它们最终交付

### 分组交换机

分组交换机是指一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。分组交换机有2种：链路层交换机和路由器

链路层交换机：基于链路层帧中的字段值做出转发决定，因此链路层交换机是链路层设备

路由器：基于网络层数据报中的字段值做出转发决定，因此路由器是网络层设备

### 4.2路由器工作原理

路由器体系结构：

- 输入端口
- 交换结构 路由器中的网络
- 输出端口  输出端口存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组
- 路由选择器  路由选择处理器执行控制平面功能

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/cf0d1b01-ddfb-43d5-a0b3-2b62e96d5131/image.png)

转发的不同方式：

- 基于目的地转发
    
    入口站服务人员根据汽车的旅途最终目的地决定汽车的出口闸道
    
- 通用转发
    
    入口站服务人员根据许多其他因素决定汽车的出口闸道
    

入口道路和入口站对应于输入端口(具有查找功能以决定本地输出端口);环状交叉路对应于交换结构;环状交叉路出口匝道对应于输出端口。
### 2024.09.25
rest
### 2024.09.26
rest
### 2024.09.27
入口道路和入口站对应于输入端口(具有查找功能以决定本地输出端口);环状交叉路对应于交换结构;环状交叉路出口匝道对应于输出端口。

### 4.2.2交换

交换的3种方式

1. 经内存交换
    
    分组到达输入端口的时候，该端口发出信号，分组被复制到路由选择处理器内存，路由选择处理器之后在转发表中找到合适的输出端口，并将该分组复制到输出端口的缓存
    
2. 经总线交换
    
    在输入端口，分组经过一条总线直接到输出端口
    
3. 经互联网络交换 
    
    纵横式交换机连接N个输入端口和N个输出端口，如果分组要从A-》Y，交换机控制器就闭合A→Y的交叉点，然后端口A在其总线上转发该分组
    

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/4772b99c-f223-4d10-96a6-cbc7818a06d9/image.png)

### 4.2.3输出端口处理

选择和取出排队的分组→链路层传输→物理层传输

### 4.2.4何处出现排队

丢包

### 输入排队

使用纵横式结构

**线路前部阻塞Head of the line(HOL)**

左下角的浅色分组要到达的右中侧的输出端口无竞争，但是该分组要等待 因为在它前面的深色分组和左上角的深色分组要输出到同一个端口，交换结构决定先发送左上角的。在它前面的深色分组就得等待。

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/91362850-63da-4129-b2cb-623a6a71489b/image.png)

### 输出排队

如果有N个输入端口的分组目的地是相同的输出端口，因为输出端口一次只能传输一个分组，那么这N个到达分组就要排队，在传输这N个分组的时候，可能又到达了N个分组

如果没有足够的内存，可能就会出现弃尾（丢弃到达的分组）

主动队列管理：在缓存填满之前丢弃一个分组，这可以向发送方提供拥塞信号

### 4.2.5分组调度

分组调度：排队的分组如何经过输出链路传输

1. 先进先出
2. 优先权排队 当选择一个分组传输时，优先全排队规则将从最高优先权类选择分组； 同一优先权类的分组先进先出
3. 循环和加权公平排队
    
    循环：循环调度器在类之间轮流提供服务；保持工作排队：有分组在等待传输的时候，不允许链路保持空闲
    

### 4.3 网际协议：IPv4\寻址、IPv6及其他

### 4.3.1 IPv4数据报格式

- 版本号 规定了数据报的IP协议版本 通过版本号，路由器能确定如何解释IP数据报的剩余部分
- 首部长度
- 服务类型 用来区分不同类型的IP数据报 eg：实时数据报（用于电话应用）和非实时
- IP数据报总长度
- 协议 仅当IP数据报到达最终目的地时才会有用 指示了IP数据报的数据部分要交给哪个特定的运输层协议（TCP/UDP)
    
    协议号是将网络层与运输层绑定到一起的粘合剂
    
    端口号是将运输层和应用层绑定到一起的粘合剂
    
- 首部检验和
    
    用于帮助路由器检测IP数据报中的比特错误
    
- 数据 IP数据报中包含要交付给目的地的运输层报文

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/0a691a94-24ad-46a4-b7be-301bc395bf79/image.png)

### 4.3.2 IPv4数据报分片

### 2024.09.28

IP数据报中的数据会被分成多个较小的数据报 然后数据报会被封装到一个链路层帧中，这些较小的数据报称为片

重组是在端系统进行的

标识号为一样的片，说明来自同一较大数据报 

每个片还包括片的偏移量（Fragment Offset），这指示该片在原始数据报中的位置。通过这个偏移量，接收方可以按正确的顺序重组片。

**片计数**：在发送端，数据报可能包含一个字段，指示总共应发送多少片（在某些情况下，应用层协议可能提供这个信息）。

IP是不可靠的 一个片可能永远也到不了目的地。标志比特中的“更多片位”（More Fragments, MF）为 0 时，表示接收到的片是最后一个片。

接收方通过标志号 偏移量 片计数和标志比特来确定是否已接收到所有预期的片

### 4.3.3 IPv4编址

主机与物理链路之间的边界叫接口

路由器与它任意一条链路之间的边界也叫接口 一个路由器有多个接口

一个IP和一个接口相关联

IP地址的长度是32比特（等价于4字节）通常用点分十进制记法（地址中的每个字节用它的十进制书写，各个字节以句点分开）eg:193.32.216.9 193是第一个8比特的十进制等价数，这种叫无类别域间路由选择，还有一种IP地址类型叫IP广播地址255.255.255.255。发送到该地址的数据包会被该子网中的所有主机接收。

### 子网

左上侧的3台主机和它们连接的路由器接口 都以223.1.1.xxx的IP地址开头 也就是说他们IP地址的最左侧的24比特是相同的。这4个接口也通过一个不包含路由器的网络连接起来，这个网络就成为子网。IP编址为这个子网分配了一个地址223.1.1.0/24 ,/24 被称为子网掩码，表示32比特中最左侧24位定义了子网地址

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/743b0d37-8046-4ddd-bd7b-2d61ac3d67c2/image.png)

**路由聚合**

一个ISP告诉外界它负责发送所有地址的前20比特和200.23.16.0/20相符的数据报 这种使用单个网络前缀通告多个网络的能力称为地址聚合 或 路由聚合

最长地址前缀 当外部的路由器需要路由到200.23.18.0？23内的地址的时候，将使用最长前缀匹配 朝着ISPs-R-Us的路由 因为它通告了与目的地相匹配的最长地址前缀

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/a077532d-1811-465a-8339-b2fa48d3e0d5/image.png)

### 一个组织是如何为其设备得到一个地址块的

ICANN组织负责分配IP地址 管理DNS根服务器 分配域名

### 一个设备如何获取它的地址：动态主机配置协议Dynamic host configuration （DHCP）又称为

可以配置DHCP 让主机每次和网络连接的时候得到相同的IP地址 也可以给主机分配临时的IP地址（每次连接这个地址也许是不同的）

DHCP是客户-服务器协议，对于一台新到达的主机，DHCP协议是4步过程

1. DHCP服务器发现 新到达的主机首要任务是发现DHCP主机，所以它使用了DHCP发现报文，并将该报文通过255.255.255.255将该报文广播到所有与该子网连接的节点
2. DHCP服务器提供 DHCP服务器（子网中可能有多台DHCP服务器）收到报文后，广播DHCP提供报文 该报文有 向客户推荐的IP地址 网络掩码还有IP地址租用期（IP地址有效的时间量）
3. DHCP请求 新到达的主机选择一个DHCP服务器，并向其提供DHCP请求报文，回显配置参数
4. DHCP ACK 服务器响应

交互就完成了 新到达的主机就可以在租用期内使用该IP地址

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/9e58c644-941a-4d5a-ac8d-30a4b883e287/image.png)

### 4.3.4 网络地址转换

NAT使能路由器

10.0.0.0/8用于家庭网络等专用网络或具有专用地址的地域

许多局域网使用了相同的地址空间10.0.0.0/24 在局域网之外就不能使用它来彼此发送分组

那么向或从全球因特网发送或接收分组的时候怎么处理编址问题？NAT

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/2026da88-4d50-493f-9f9f-fc80a75b8e78/image.png)

所有从家庭路由器流向更大因特网的报文都有一个源IP地址，即138.76.29.7 所有进入家庭路由器的报文都有同一个目的IP地址138.76.29.7。因为所有进入家庭路由器的报文都有同一个目的IP地址138.76.29.7，那么路由器怎么知道分组要给到内部哪台主机？NAT转换表

主机10.0.0.1的源端口3345要请求128.119.40.186上的web页面→NAT路由器收到该数据报后为其生成新的端口号5001并将源IP替换为广域网一侧的IP地址138.76.29.7

NAT 路由器会在其转换表中新增一条表项，记录以下信息：

- **内部地址**：10.0.0.1
- **内部端口**：3345
- **外部地址**：138.76.29.7
- **外部端口**：5001
- **对应的状态信息**：用于跟踪会话。

→NAT在转换表中新增一表项→web服务器响应，响应报文中的目的地址是NAT路由器的IP地址→路由器收到后 从NAT转换表中检索出对应的IP地址和端口号，重写，并发送该数据报

### 4.3.5 IPv6

### 数据报格式

IPv6将IP地址长度从32比特增加到128比特 

- 可用的 IP 地址数量为2^{128}，大约是**3.4×10^{38}**个地址，这相当于**340 度量级的非亿亿亿亿个地址；** IPv6还引入了任播地址
- 流标签 用于处理发送方要求进行特殊处理的流，比如音频和视频传输；能够对一条流中的某些数据报给出优先权，或者对来自某些应用的数据报给出优先权

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/7322174c-6876-4391-9d30-0e68c2b7282a/image.png)

- 有效荷载长度 给出IPv6数据报中跟在定长的40字节数据报首部后面的字节数量。有效荷载长度让接收方知道需要处理多少数据
IPv6 数据报的总长度 = **40 字节（固定首部）** + **有效荷载长度**
- 下一个首部 标识数据报中的内容需要交付给哪个协议（如TCP或UDP)
- 跳限制（TTL) 转发数据报的每台路由器将对该字段的内容减去1 当值为0的时候，该数据报被丢弃。
主要目的是防止数据报在网络中**无限循环**，并确保它们在一定时间内被丢弃，避免网络资源的浪费。

### IPv4和IPv6数据报的比较

IPv4字段在IPv6数据报中不复存在：

- 分片/重新组装 IPv6不允许分片 如果数据报太大，路由器就会丢掉该数据报，并向发送方发一个分组太大的差错报文，发送方就重新发送一个较小长度的IP数据报。分片是耗时的，这种就加快了网络中IP转发速度
- 首部检验和
- 选项

### 从IPv4迁移到IPv6

IPv6能接收IPv4 IPv4却不能处理IPv6数据报 解决方法：建隧道

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/012b9a53-807e-471d-bdb6-93ec05a179f6/image.png)

将两台IPv6路由器之间的IPv4路由器的集合称为一个隧道

借助隧道，IPv6节点B可以将整个IPv6数据报放到IPv4数据报的数据字段中，这个IPv4数据报的地址被设为隧道接收端的IPv6节点

### 4.4 通用转发和SDN（软件定义网络）

防火墙：

**防火墙**可以根据**网络数据包首部字段**中的特定信息来**拦截（阻止）或重定向**网络流量
网络数据包首部字段 包含了源 IP 地址 和 目标 IP 地址，源端口号 和 目标端口号
防火墙可以通过查看数据包首部中的字段值，决定要丢弃（也就是拦截）这个包还是重定向这个包。

通用转发：

- **通用转发**不仅仅依赖于数据包的**目的地址**，还可以根据**源地址**、**协议类型**、**端口号**、**流量优先级**等多个数据包首部的字段（就是下面的流表的分组匹配字段）来进行决策。
- 通用转发不仅限于将数据包发往**一个输出端口**，而是可以通过多个**输出端口**进行广播、组播或者负载均衡。
- **灵活的动作选择**：除了决定数据包的转发路径，通用转发还可以执行其他操作，如**修改数据包的内容**（例如更改TTL、重新封装）、甚至**丢弃**数据包。

**目的地转发**是一种基于目的地地址的简单转发方式，数据包通常只转发到一个输出端口，适用于单播通信。而且只有一个动作：转发

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/2aba98a4-dce9-481b-9aa2-0316f938897b/image.png)

匹配加动作转发表在Openflow中称为流表 它包括

- 首部字段值的集合
- 计数器集合
- 分组匹配流表项时的所采取的动作集合 包括将分组转发到给定的输出端口，丢弃分组，复制分组或将它们发送到多个输出端口

### 4.4.1 匹配

流表的分组匹配字段：

- 入端口 分组交换机上接收分组的输入端口
- 流表项也可以有通配符  如一个流表中IP地址为128.119.*.*将匹配其地址的前16比特为128.119的任何数据报所对应的地址字段

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/118da196-6009-4590-8849-d38f36e58b2a/image.png)

### 4.4.2 动作

动作决定了应用于与流表项匹配的分组的处理

- 转发 一个入分组可以转发到一个特定的物理输出接口，广播到所有接口，或通过所选的端口集合进行多播；该分组也可能被封装并发送到远程控制器（当该分组**不匹配现有的流表项**），远程控制器对该分组采取：安装新的流表项，一旦新的流表项被安装，网络设备可以在后续的流量处理中根据新的规则自动转发相同类型的分组
    
    或者 将该分组返回给该设备，让设备能够立即处理这个特定的分组，而不是等待新的流表项完全生效后才处理。
    
    - 远程控制器接收到设备发送的未匹配分组。
    - 控制器创建一条新的流表规则，并将这条规则下发给网络设备。
    - 设备在流表更新之后再对该分组进行转发
    
    或者 控制器把该特定的分组返回给网络设备，允许它立即根据新规则处理该分组。
    
- 丢弃 没有动作的流表项会被丢弃
- 修改字段 在分组被发到输出端口之前，分组首部10个字段的值可以被重写

### 4.4.3 匹配加动作操作中的OpenFlow例子

eg1:简单转发

eg2:负载均衡 发往同一目的地的不同源会经过不同的链路

### 2024.09.29
rest
### 2024.09.30
rest
### 2024.10.01
rest
### 2024.10.02
rest
### 2024.10.03
rest
### 2024.10.04
rest
### 2024.10.05
rest
### 2024.10.06
rest
### 2024.10.07
rest
### 2024.10.08
### 5.3 因特网自治系统内部的路由选择：OSPF（Open Shortest Path First）

同一类型的路由器群存在的问题：
规模：都采取广播 那要广播很多；都采取距离路由算法要迭代很久
管理自治：每个ISP要自治又要相互连接

这些问题可以通过自治系统（AS automatic system）来解决，AS由一组处在相同控制管理下的路由器组成
通常一个ISP其中的路由器和链路就组成了一个AS

OSPF是一种链路状态协议，使用了洪泛链路状态和Dijkstra算法
OSPF 报文直接由ＩＰ承载
洪泛链路状态：当一个节点检测到有新的链路或链路断开时 会产生新的链路连接状态信息并将新消息通知其直接相连的节点，然后直接相连的节点又会告诉其他节点，直到整个节点都有相同的路由状态信息。然后每个节点会使用Dijkstra算法来计算到达网络中任意目的地的最佳路径

OSPF 不强制使用权重赋值，而是提供了最低开销路径。而是基于链路的开销（cost）来确定最低开销路径，链路开销通常是根据链路带宽自动计算得出的，但是网络管理员也可以手动配置

### 5.4 ISP之间的路由选择：BGP(border gateway protocol)边界网关协议

**5.4.1 BGP的作用**

对于在相同AS的路由器之间的通信 输出的链路由AS内部的路由选择协议所决定

对于不同的AS的路由器之间的通信 输出链路就由BGP决定

1. 通告BGP路由信息。一个子网宣布：“我在这里”，BGP会确保因特网中的所有AS知道该子网
2. 确定到该前缀的“最好的”路由 

**5.4.2 通告BGP路由信息**

对于每个AS，每台路由器要么是一台网关路由器，要么是内部路由器

网关路由器：位于AS边缘的路由器，直接连接到在其他AS中的一台或多台路由器

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/df969a10-423c-4166-95c7-4d65a4e1bab9/image.png)

每对路由器使用TCP连接交换路由选择信息，每条直接连接以及所有通过该连接发送的BGP报文称为BGP连接；跨越2个AS的BGP连接称为**外部BGP连接**，在相同AS中的两台路由器之间的BGP会话称为**内部BGP**

通告前缀x的可达性的过程：

1. 3a路由器向网关路由器2c发送eBGP报文“AS3 x”
2. 2c向AS2中所有其他路由器发送iBGP报文“AS3 x”
3. 2a向1c发送eBGP报文”AS2 AS3 x”表示可以通过AS2向AS3发送信息
4. 1c使用iBGP向AS1中所有路由器发送报文”AS2 AS3 x”

这样 AS1 2中所有路由器都知道通往x的AS路径

**5.4.3 确定到该前缀的“最好的”路由** 

BGP属性和前缀统称为路由；2个重要的BGP属性：AS-Path 和 Next-Hop

AS-Path属性包含了通告已经通过的AS列表 比如”AS2 AS3 x”就是一条AS-Path

Next-Hop AS-Path起始的路由器接口的IP地址 对于”AS2 AS3 x”来说，路由器2a左边接口的IP地址就是NEXT-HOP

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/f8fe7f9a-409c-4ba7-a55f-9916425448ef/image.png)

BGP路由选择算法：

1. 热土豆路由选择
    
    从所有路由中会选择一条这样的路由：到NEXT-HOP路由器有最小开销
    
    对于1b 会选择到2a 而不是3d，之所以叫热土豆，是因为3b想尽快把分组送出其AS，分组就像烫手的土豆
    
2. 路由器选择算法

在实践中 BGP使用了更复杂的路由选择算法：

如果有多条路由，BGP会按下列顺序筛选直到剩下一条路由

1. 本地偏好
2. 余下的路由选择最短AS-path的路由
3. 余下的路由使用热土豆路由
4. 余下的路由使用BGP标识符

所以 对于1b 会选择到3d，因为到第2步判断的时候到3d的AS-path较短

BGP还用于实现：IP任播

**5.4.4 IP任播**

CDN公司为多台服务器分配一样的IP地址，BGP路由器会对这些服务器配置不同的路径，路由器配置路由选择表的时候会根据BGP路由选择算法来条最好的路由。

当客户想要向那个IP地址发送请求的时候，路由器则向最近的服务器转发该请求分组，最近的服务器是由BGP路由器决定的

**定义**：IP 任播是一种网络地址分配和路由方式，在这种方式中，多个节点可以共享相同的 IP 地址。用户的数据包会自动被路由到距离最近或响应最快的节点。

**5.4.5 路由选择策略**

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/48d58dd4-7002-4bea-89d4-f7440c8b0ecb/image.png)

X（多宿接入ISP）通过向B通告它只有通向B的路径 来起到接入ISP的作用，它就不会转发B到C之间的流量 

AS内和AS间的路由选择差别：

- 策略 AS间，一个给定AS的流量不能穿过另外一个AS（实现是由BGP实现的）；而AS内部 一切都是在相同的管理下进行的
- 规模 AS间可扩展能力很重要 AS内部可扩展不是真的，如果单个AS太大 就可以分成2个
- 性能 AS内部更加关注性能

**5.4.6 整合概念**

一家公司有公共web服务器，DNS服务器和电子邮件服务器

1. 获得因特网连接 和本地ISP签订合同，并得到网关路由、IP地址范围。在这里，本地ISP将使用BGP向与之连接的ISP通告公司的前缀，依次通告，直到整个网络的路由器都知道该前缀
2. 获得公司域名 配置公司DNS服务器的IP地址
3. 在DNS服务器中配置公共web服务器和IP地址的映射

Alice要浏览web服务器：

1. DNS系统联系你的DNS服务，找到你的web服务器IP
2. Alice向该IP发送一个IP数据报，任何路由器收到IP数据报后，会在转发表里面找一个表项来确定输出端口，所以要知道公司的/24前缀（看第一步）

### 5.5 SDN控制平面

SDN体系结构的4个关键特征

1. 基于流的转发
2. 数据平面与控制平面分离
    
    ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/d0d8b732-c69e-47ea-bd4b-8fe0bc62f25b/image.png)
    
3. 网络控制功能：位于数据平面交换机外部
    
    控制平面本身由2个组件组成：1个SDN控制器（维护准确的网络状态信息）和若干网络控制程序（这些程序能控制下面的网络设备）
    
4. 可编程网络

### 5.5.1 SDN控制平面：SDN控制器和SDN网络控制应用程序

SDN控制器

- 通信：SDN控制器和受控设备之间的通信 需要一个协议来传送控制器和这些设备之间的信息。控制器和受控设备之间的通信跨越了一个接口，被称为南向接口（eg：Openflow）
- 网络范围状态管理层 控制器有有关网络的主机、链路、交换机的最新状态信息
- 给网络控制应用程序的接口 被称为“北向”接口

SDN控制器被认为是“逻辑上集中的” 该控制器可以被外部视为一个单一的整体服务；但是在实践中这些服务通过分布式服务器实现

### 5.5.2 Openflow协议

运行在TCP之上，使用6653端口

从控制器到受控交换机之间流动的报文有：（由控制器使用的）

- 交换机配置
- 交换机流表中的表项

等等

从受控交换机到控制器之间流动的报文由受控交换机使用

### 5.5.3 数据平面和控制平面交互的例子

假设s1和s2之间的链路断开，

1. 断开故障发生后，s1使用openflow“端口状态”报文向SDN控制器通报该链路状态的更新
2. SDN控制器接收报文，并通告链路状态管理器，管理器更新链路状态库
3. 实现链路状态路由选择的网络控制应用程序收到链路状态更新通告。接收链路状态更新
4. 链路状态路由选择应用程序与链路状态管理器相互作用得到更新的链路状态并计算新的最低开销路径 和第3步的区别？
5. 链路状态路由选择应用程序与流表管理器交互 因为最低开销路径变了
6. 流表管理器更新交换机的流表项

### SDN控制器案例：OpenDayLight控制器和ONOS控制器

### 5.6 ICMP:因特网控制报文协议

ICMP因特网控制报文协议 典型用途是差错报告 eg: IP路由器找不到一条通往请求指定的主机的路径就会报错“目的网络不可达”

ICMP报文是作为IP有效荷载承载的 ，就像TCP和UDP是IP有效荷载被承载

IP数据报的分解和处理方式：

- 在IP协议中，数据的有效载荷（Payload）可以是不同的上层协议数据，比如TCP、UDP或ICMP。
- 当IP层收到一个IP数据报时，会查看数据报头中的上层协议字段（协议号），以确定该数据报承载的是哪种上层协议的数据。
- 比如，如果上层协议字段值表明这是一个UDP数据报，IP层会将数据报的有效载荷交给UDP协议处理；类似地，如果上层协议字段值为1（表示ICMP协议），则IP层将数据报内容交给ICMP协议处理。
- 这意味着无论数据报的上层协议是TCP、UDP，还是ICMP，IP层都将有效载荷“解包”并传递给相应的上层协议来处理，就好像在处理一个普通的数据报一样。

ping程序就是发送ICMP类型的报文到指定主机

能够跟踪一台主机到世界上任何一台主机之间的路由到Traceroute程序是用ICMP类型实现的，能够得到源和目的地之间所有路由器的名字和地址

### 5.7 网络管理和SNMP

**5.7.1 网络管理框架**

- 管理服务器 是一个应用程序 在这里，发起控制网络行为的动作
- 被管设备 在一个被管设备中有几个被管对象（设备中硬件的实际部分eg:网络接口卡 和用于这些硬件的配置参数）
- 管理信息库（Management Information Base,MIB） 信息可以被管理服务器使用。信息对象可以是：丢弃的IP数据报的数量；一台主机接受到的UDP报文段的数量
- 网络管理代理 运行在被管设备的一个进程，与管理服务器通信，执行管理服务器的命令
- 网络管理协议 允许管理服务器查询被管设备的状态 并通过其代理间接地在这些设备上行动

**5.7.2 简单网络管理协议（Simple Network Management Protocol）**SNMP

简单网络管理协议是一个应用层协议

管理服务器 向 SNMP代理发送一个请求 代理收到后执行动作，并对该请求发送回答

SNMP代理 向 管理服务器发送非请求报文 该报文被称为**陷阱报文**， 用于通知管理服务器异常情况导致MIB对象改变

SNMP通常是作为UDP数据报的荷载进行传输的

### 2024.10.09
总结
### 2024.10.10
# 第6章 链路层和局域网

## 2种不同类型的链路层信道

### 广播信道

连接接入网中的多台主机

### 点对点通信链路

在长距离链路连接的两台路由器之间 或 办公室计算机与它们所连接的交换机之间

## 6.1 链路层概述

### 6.1.1 链路层提供的服务

链路层提供的可能服务包括：

- 成帧 每个网络层数据经链路传送之前 所有的链路层协议都要将其用链路层帧封装起来。一个帧由一个数据字段和若干首部字段组成，其中网络层数据报就插在数据字段中
- 链路接入 媒体访问控制协议（Medium Access Control）MAC规定了帧在链路上传输的规则
- 可靠交付 保证无差错地经链路层移动每个网络层数据报。通常用于无线链路。在差错发生的链路上纠正一个差错
- 差错检测和纠正 通过让发送节点在帧中包括差错检测比特，让接收节点进行差错检查来完成此项工作

### 6.1.2 链路层在何处实现

链路层在路由器是通过线路卡实现的

在主机中是硬件部分在网络接口卡 （网络适配器） 部分链路层运行在主机CPU上的软件。链路层是协议栈中软件和硬件交接的地方。

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/1458a419-65dc-412d-8274-2ba1032757e7/image.png)

## 6.2 差错检测和纠正技术

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/8b26a2d7-1f83-4c97-a60d-6de5636fa78e/image.png)

差错检测和纠正比特（Error detection and correction,EDC）是用来增强数据D的 

差错检测：接收方是否检测到一个差错

即使使用了差错检测也有可能出现未检出比特差错

差错检测的3种技术：奇偶校验、校验和方法和循环冗余校验

### 6.2.1 奇偶校验

单个奇偶校验位：

偶校验方案：发送方包含一个附加的比特，选择它的值，使得d+1比特中1的总数是偶数

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/82b858f5-d904-4b2a-9fdb-0964670af019/image.png)

奇校验方案相反

**二维奇偶校验**

二维奇偶校验可以检查出错的事实，还可以利用行列索引来识别并纠正

奇偶校验位的计算在发送和接收方都会进行 但是校验是在接收方

接收方检测和纠正差错的能力被称为前向纠错，减少了发送方重发的次数

### 6.2.2 检验和方法

**因特网检测和** ：

1. 检验和的计算过程

- **数据分组**：首先，将要传输的数据分成多个固定大小的部分（例如16位）。
- **取和**：
    - 对这些数据块进行取和操作，计算它们的总和
- **求反码**：
    - 最后，计算出总和的反码，这个反码就是检验和值。这样做的目的是使得检验和的值在没有错误时为全1
1. 接收方的验证过程
- 接收方收到数据后，同样会对所有数据块进行取和，并计算得到一个总和。
- 如果发送方计算出的检验和和接收方计算出的值一致（通常是全1），则说明数据在传输过程中没有错误。

按位异或（XOR）运算是相同为0，不同为1的运算

**循环冗余检测Cyclic Redundancy check(CRC)**

CRC编码也被称为多项式编码，因为该编码将要发送的比特串看作为系数是0和1的一个多项式

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/c7712ce5-fdc2-4ae9-8aa5-2b73c859ab13/image.png)

使用CRC进行差错检测的过程：接收方用G去除接受到的d+r比特，如果余数为非零，接收方知道出现了差错，否则认为数据正确而被接受

- 模2算术的基本规则
    
    模2算术的主要运算是加法和乘法，它们与普通算术有一些不同的规则：
    在模2算术中，**加法和减法都是按位异或运算**（XOR）
    
    1. **模2加法**（相当于按位异或）：
        - 0 + 0 = 0
        - 0 + 1 = 1
        - 1 + 0 = 1
        - 1 + 1 = 0（结果为0，并且没有进位）
        
        可以看出，模2加法就是对两个二进制位进行按位异或运算。
        
    2. **模2乘法**：
        - 0 × 0 = 0
        - 0 × 1 = 0
        - 1 × 0 = 0
        - 1 × 1 = 1
        
        模2乘法与普通的二进制乘法相同。
        

### 原理解释

1. **生成多项式  G**   ：
    - 在 CRC 中，生成多项式  G  是一个二进制数，代表用于生成校验码的公式。例如，   G = 1101  对应的多项式是  G(x) = x^3 + x^2 + 1   。
2. **数据  D**   ：
    - 发送的数据  D  被视为一个二进制数。为了计算 CRC，   D  需要被扩展（通常是在后面添加  n  个零，   n  是  G  的位数），这样做是为了保证在进行模2除法时，可以获得完整的余数。
3. **扩展数据**：
    - 将数据  D  扩展为  D * 2^n  实际上是将  D  左移  n  位，这样就可以确保在进行模2除法时，不会影响原始数据的位值。例如，   D = 110101  扩展后变为  1101010000   （如果  n = 4   ，即  G  有4位）。
4. **模2除法**：
    - 进行模2除法的过程类似于常规的长除法，只不过使用的是按位异或而不是减法。每次将  G 从当前的被除数中减去时（通过异或操作），都会影响到余数的位值。
5. **余数  R**   ：
    - 当模2除法完成后，得到的余数  R （CRC 校验码）就是   D   与  G  的模2除法的结果。这意味着在发送数据时，发送的数据 D 加上这个余数 R  就是完整的帧数据。

### 重要性

- **确保数据完整性**：CRC 余数 R 被附加到数据后，接收方可以使用相同的  G 对接收到的完整数据进行模2除法，检查余数是否为0。如果为0，则数据未损坏；如果不为0，则说明在传输过程中发生了错误。

### 2024.10.11
## 6.3 多路访问链路和协议

点对点链路由链路一端的单个发送方和链路另一端的单个接收方组成

广播链路 eg:以太网和无线局域网 广播：任何一个节点传输一个帧的时候，信道广播该帧 

**多路访问协议**

多个节点同时传输帧，所有节点同时接到多个帧 这就是传输的帧在所有接收方处碰撞

涉及碰撞的所有帧都会被丢失

**多路访问协议有3种：**

1. 信道划分协议
2. 随机接入协议
3. 轮流协议

### **6.3.1信道划分协议**

**时分多路复用（TDM）:**
TDM将时间划分为时间帧，并进一步划分每个时间帧为N个时隙，然后把每个时隙分给N个节点中的一个

酒会的类比：每个客人在固定的时间段发言 然后再允许另外一个客人发言同样的时长

优点：消除了碰撞

缺点：节点被限制在R/N bps的速率；节点必须等到它在传输序列中的轮次 即使它是唯一一个有帧要发送的节点

**频分多路复用FDM**

**码分多址Code division multiple access CDMA**

对每个节点分配一种不同的编码 ，节点用它的唯一编码对它要发送的数据进行编码，使不同节点能同时传输，并且相应的接收方能够正确接收到（抗干扰）

### 6.3.2 随机接入协议

在 随机接入协议中 一个传输节点总是以信道的全部速率进行发送 当有碰撞的时候，该节点会反复重发它的帧，直到该帧无碰撞地通过为止。重发之前会等待一个随机时延

常用的随机接入协议：

1. 时隙ALOHA协议
    - 一个时隙等于传输一帧的时间
    - 节点只在时隙起点开始传输帧
    - 如果在一个时隙中有两个或更多个帧碰撞，则所有节点在该时隙结束之前检测到该碰撞
    
    以概率p重传 协议的步骤：
    
    - 节点有新帧要发送的时候 等到下一个时隙开始并在该时隙传输整个帧
    - 如果有碰撞 节点在时隙结束之前检测到该次碰撞。该节点以概率p在后续的时隙中重传它的帧 直到该帧被无碰撞地传输出去
    
    优点：
    
    - 节点以全速R连续传输
    - 每个节点检测碰撞并独立决定什么时候重传
    
    有多个要发送帧的节点的时候的效率：
    
    1. 时隙碰撞 被浪费掉
    2. 时隙空闲 因为节点由于概率传输策略会节制传输
    3. 刚好有一个节点要传输的时隙称为成功时隙
    
    时隙多路访问协议的效率： 当有大量的活跃节点且每个节点总有大量的帧要发送的时候，长期运行中成功时隙的份额。
    
    时隙多路访问协议最大效率推导过程：假设有N个节点，一个给定节点传输的概率是p，剩余节点不传输的概率是（1-p）的n-1次方；一个给定节点成功传送的概率是
    
    $$
    p(1-p)^{N-1}
    $$
    
    N个给定节点成功传送的概率是
    
    $$
    Np(1-p)^{N-1}
    $$
    
    这个协议的最大效率是0.37，也就是说 该信道的有效传输效率是0.37R bps
    
    纯ALOHA协议的最大效率是时隙ALOHA的一半
    

纯ALOHA协议**发送时机**：节点可以在任何时刻发送数据，不需要等待特定时隙。每当一个节点有数据要发送，它可以立即发送。

时隙ALOHA协议**发送时机**：时隙ALOHA将时间分成固定长度的时隙，节点只能在时隙的开始时间发送数据。所有设备同步使用这些时隙，因此数据只能在时隙开始时发送。

1. **载波侦听多路访问CSMA（carrier sense multiple access）**
- 一个节点在传输之前先听信道（载波侦听多路访问）
- 一个传输节点在传输时一直在侦听此信道 如果检测到干扰 就会停止（碰撞检测）
1. 具有碰撞检测到载波侦听多路访问（CSMA/CD）
    
    运行步骤：
    
    1. 适配器将数据报封装为帧
    2. 如果适配器侦听到信道空闲，就开始传输帧；如果信道正忙，就会等待 直到没有信号才开始传输.“侦听-当空闲时传输”
    3. 在传输过程中，监视其他适配器的信号能量
    4. 如果检测到其他适配器的信号能量，就中止传输
    5. 中止传输后，适配器等待一个随机时间，然后返回步骤2
    
    等待时间多久合适？当碰撞节点少时，时间间隔较短；当碰撞节点数量较大时，时间间隔较长
    
    实现方式：二进制指数后退
    
2. CSMA/CD效率
    
    当有大量节点且每个节点又大量帧要发送的时候 帧在信道中无碰撞地传输的那部分时间在长期运行时间中所占的份额
    

### 6.3.3 轮流协议

2种常用的轮流协议：

1. 轮询协议
    
    节点之中有一个是主节点 主节点以循环的方式轮询每个节点，依次告诉每个节点，该节点能传输的帧的最多数量
    
    缺点：1. 引入了轮询时延 2. 主节点有故障，整个信道都不可操作
    
    eg: 蓝牙协议
    
2. 令牌传递协议
    
    没有主节点，一个被称为令牌的特殊帧在节点之间交换
    
    一个节点收到令牌的时候，如果有要发送的帧，就发送，然后把令牌转发给下一个节点 如果没有，就立即把令牌转发出去
    
    令牌传递协议是只有持有令牌的才能转发帧
    

### 6.3.4 DOCSIS用于电缆因特网接入的链路层协议

**下行网络**和**上行网络**指的是数据传输的方向：

1. **下行网络**（Downstream Network）：这是从互联网服务提供商 (ISP) 的网络到用户设备的传输方向。也就是说，数据是从中心设备（如电缆调制解调器终端系统 CMTS）发送到用户的调制解调器。**下行传输**包括用户从互联网下载数据（例如，视频流、网页内容等）。
2. **上行网络**（Upstream Network）：这是从用户设备到ISP网络的传输方向。即数据从用户的调制解调器传输回CMTS。这种方向上的数据包括用户上传的内容（例如，发送电子邮件、上传文件）以及请求（例如，访问网站的请求）。

DOCSIS使用FDM将下行和上行网络段划分为多个频率信道。上下行信道均为广播信道

每个上行信道被划分为时间间隔 ，时间间隔有微时隙，电缆调制解调器可以在该微时隙向CMTS传输。

CMTS（电缆调制解调器终端系统）在下行信道通过发送MAP报文，指定哪个解调器（带有要发送的数据）能够在微时隙中传输，所以没有碰撞

解调器在没有下一个下行报文中收到对请求分配的响应（也就是自己不能发送数据）就推断自己的请求帧经历了碰撞。就使用二进制指数回退将微时隙请求帧延缓到以后的时隙（调制解调器会选择在未来的某个微时隙再次发送请求，直到成功分配到传输时间为止。）

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/a7b8bd10-eb1c-457c-8e5d-5cae2b50e716/image.png)

## 6.4 交换局域网

### 6.4.1 链路层寻址和ARP

1. MAC地址
    
    主机和路由器的网络接口具有链路层地址（又叫做MAC地址）
    
    MAC地址长度为6字节 1个字节被表示为一对十六进制数 1A-32-F9-CD-06-9B
    
    **没有两块适配器具有相同的地址,每个接口都有一个唯一的MAC地址**
    
    该地址不会变（具有扁平结构）这和IP地址相反（IP地址是层次结构，主机移动，连接到的网络改变。IP地址就改变）
    
    当适配器接收到一个帧的时候 会检查该帧的目的MAC地址是否和它自己的MAC地址匹配，如果匹配，就会提取出封装的数据报，将该数据报沿着协议栈向上传递。如果不匹配，就丢弃
    
    如果要所有适配器都接收并处理一个帧，发送适配器就可以在该帧的目的地址字段插入一个特殊的MAC广播地址
    
    为了保持各层独立 所以主机接口除了网络层地址外还有MAC地址
    
    有3种类型的地址：1. 应用层的主机名 2. 网络层的IP地址 3.链路层的MAC地址
    
2. 地址解析协议
    
    协议的任务：转换网络层地址和链路层地址
    
    ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a6ca9822-e902-41f9-90d9-747f9ae75db0/5fa96d67-bb90-4786-9531-d583dfe02c25/image.png)
    
    发送主机要得到IP地址为222.222.222.222的MAC地址，它使用ARP
    
    ARP可以将一个IP地址解析为一个MAC地址；DNS将主机名解析为IP地址
    
    ARP只为在同一个子网上的主机接口解析IP地址 ；DNS为在因特网中任何地方的主机解析主机名
<!-- Content_END -->
